---
layout: post
title:  "记一次折腾：Hyper-V、Dism与BCD"
date:   2016-04-13 18:19:44
tags: [折腾,虚拟化,Hyper-V,Windows]
---

事情的起源，是我突然想玩玩Adroid开发。或者说是移动开发。出于跨平台的目的，选择了Xamarin。之前为了开发CUDA都在用Visual Studio 2013，不过这个既然是新的，就全上2015吧。

#症状

安装VS2015的时候，出现了第一个凶兆：装完需要重启，重启过程中，居然提示，无法完成配置，正在撤销更改云云。不过重启完了之后也没见有啥异常，想想系统用久了也就那样吧，打开，新建工程，编译，也没啥问题。

开发自然需要调试，真机调试了一把，手感还好，然而毕竟传输太慢，想找个模拟器。然而！听说微软自带了一个Android模拟器，在哪儿呢？没有。于是再启动安装程序，Modify，找到Android模拟器组件，打钩，确认，安装完毕，重启……卧槽，“无法完成配置，正在撤销更改”。

于是再找原因，网上提示是Hyper-V没打开，想想确实之前关掉了，于是看控制面板，Windows功能，发现这里显示是开着的，然而开始菜单中没有相应的管理器一类。

麻烦大了。

#重装

Windows问题解决手册第一条，重来！于是在这里关掉Hyper-V，确定，重启，没问题，很好。再打开Hyper-V，重启……“无法完成配置，正在撤销更改”……此路不通。

然而可以确定，问题的根源出在Hyper-V挂了。

#查错

这种问题可能两个月前就出了，然而我平时不用它，到现在才发现，想去找原因自然是不现实的。好在Hyper-V就是个系统标准件，还有`sfc`大法呢。

```
sfc /scannow
```

输出结果：发现了错误文件，但是无法修复。我X！

继续谷歌大法，发现Win 8以上，还有一个修复大法Dism

```
Dism /Online /Cleanup-Image /RestoreHealth
```

> 这里需要解释一句，`/Online`不像我刚开始一维的那样是指联网修复，而是指修复对象是当前在线的这个系统。此参数也可以用`/Image:XXX.wim`替换。`/Cleanup-Image`也不是清空的意思，而是修复、整理。
>论程序猿学好语文的重要性。

虽然`/Online`不是联网的意思，这个命令的确会联网检查文件，然后下载需要修复的文件。生活在一个不会那啥就算文盲的国度，这个需要联网的命令自然是基本用不成的。好在`Dism`也可以离线工作：

```
Dism /Online /Cleanup-Image /RestoreHealth /Source:wim:D:\path\to\install.wim:1
```

`Source`选项指定工作所用的离线源，`wim:`前缀是指使用`wim`映像文件，这个当时安装系统的光盘里有。`:1`后缀是指影响中的是第一个映像。这个不展开说了。

*然而！*此命令的结果是，“找不到源文件”……

#走投无路

```
Dism /Online /Cleanup-Image /RestoreHealth
The source files could not be found.
```

谷歌了半个下午，网上翻来覆去就那么几句话，有让我挂载或者wim文件的，有让禁用再启用Windows update服务的，不一而足，全都无效。唯一收获就是得出结论：微软在线客服基本上没解决过什么问题。

其间尝试了启动到安装光盘，在光盘中运行此命令，结果一样。

#换个角度

到这时为止，我仍不知道到底是什么文件坏了。看日志好像是`opencl.dll`，但是一个显卡相关的文件真能影响Hyper-V？我貌似跑的太远了。

回头，再次尝试启用Hyper-V，不出所料的失败，找日志`C:\Windows\Logs\CBS\CBS.log`，发现了两条安装过程中的`Error`，一个是`C:\Windows\System32`有多重权限，貌似是一个账户出现了两次但是权限设置不一致。搜了一下，信息很杂，但是没有指向Hyper-V的，无视。毕竟`System32`整个出问题的话，早就关了。另一条是指向`bcd`什么什么的，一长串。`bcd`是Windows启动相关的东西，本来我是不太重视的，但是搜到一个英文帖子里面说，有人回帖说“我的Hyper-V也是老卡在安装bcd的时候”。

但是`BCD`我没动过啊。再次陷入僵局。不过死马当成活马医吧，再次启动到光盘，试图修复一下启动项。等待启动的时候却想到，`Dism`命令不行，能不能直接在现有系统上执行一次升级安装呢？那不就系统文件都回来了。

#柳暗花明

安装光盘，进入升级安装，结果没有预料中的确认，反而是弹出了一个兼容性检查一类的窗口。窗口没什么干货，我却突然由“省级兼容性”想到，问题出在这个光盘！这是我2015年10月下载的安装光盘，然而Win 10在2016年二月进行了一次重大升级，我当时是直接在线安装的！光盘过期了！

于是重新下载2016年版的光盘，执行！

```
Dism /Online /Cleanup-Image /RestoreHealth /Source:wim:D:\path\to\install.wim:1
// You shall check to make sure \path\toinstall.wim points to the right version of file
// Especially when your windows had experenced a major upgrade
// 这里的 \path\toinstall.wim 必须指向与当前系统一样版本的安装光盘，如果进行过重大版本更新，可能需要下载新版安装光盘
```

成功！

但是貌似还不够，此时系统文件还不保证就好了，最好再来一次`sfc`大法。

```
sfc /scannow
```

成功！

既然来了安装光盘，就再修一下`bcd`吧，之前玩儿Linux虽然没有安装到同一分区，但是也许文件被动过了。

```
bootrec /fixboot
bootrec /rebuildbcd
```

成功！

重启回到系统，再次尝试打开Hyper-V，成功！修改VS2015组件，添加Android模拟器，自然还是成功。

折腾完毕。

#后记

##一个工具

[Rufus 中文绿色版 - 简单快速制作 USB 启动盘软件 (U盘安装 Windows 或 Linux 系统)](http://www.iplaysoft.com/rufus.html)

##UEFI启动-破除思维定势

本来我的U盘，台电的便宜货USB3.0蓝色金属壳盘，貌似是不能分区的，所以一直以为很难用来装UEFI启动的系统。然而此次上面的Rufus工具也可以成功把光盘写进去，仔细一看才发现，它是把整个盘搞成了FAT32，把boot文件和系统放在一起。

真是思维定势啊，不能分区就不能搞EFI分区了吗？EFI分区又不问大小的，只要是第一个FAT32分区，里面有boot文件不就行了……